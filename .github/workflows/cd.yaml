name: CD - Build & Push Serving Images

on:
  push:
    branches: [main]
    paths:
      - 'docker/**'
      - 'scripts/serve/**'
      - 'etpgt/**'
      - 'requirements-serve*.txt'
      - 'pyproject.toml'

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_REGION: ${{ secrets.GCP_REGION }}
  AR_REPO: ${{ secrets.AR_REPO }}

jobs:
  build-scan-push:
    name: Build & Push (${{ matrix.variant.name }})
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    strategy:
      fail-fast: false
      matrix:
        variant:
          - name: pytorch
            dockerfile: docker/serve.Dockerfile
            image_suffix: etpgt-serve
          - name: onnx
            dockerfile: docker/serve-onnx.Dockerfile
            image_suffix: etpgt-serve-onnx
    outputs:
      pytorch_image: ${{ steps.meta.outputs.pytorch_image }}
      onnx_image: ${{ steps.meta.outputs.onnx_image }}

    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev

      - name: Build image
        run: |
          IMAGE="${{ env.AR_REPO }}/${{ matrix.variant.image_suffix }}"
          docker build -f ${{ matrix.variant.dockerfile }} \
            -t ${IMAGE}:${{ github.sha }} \
            -t ${IMAGE}:latest \
            .

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ env.AR_REPO }}/${{ matrix.variant.image_suffix }}:${{ github.sha }}'
          format: 'table'
          exit-code: '1'
          severity: 'CRITICAL,HIGH'
          ignore-unfixed: true

      - name: Push image
        run: |
          IMAGE="${{ env.AR_REPO }}/${{ matrix.variant.image_suffix }}"
          docker push ${IMAGE}:${{ github.sha }}
          docker push ${IMAGE}:latest

      - name: Set output
        id: meta
        run: |
          IMAGE="${{ env.AR_REPO }}/${{ matrix.variant.image_suffix }}:${{ github.sha }}"
          echo "${{ matrix.variant.name }}_image=${IMAGE}" >> $GITHUB_OUTPUT

  smoke-test:
    name: Smoke Test (${{ matrix.variant.name }})
    runs-on: ubuntu-latest
    needs: [build-scan-push]
    strategy:
      matrix:
        variant:
          - name: pytorch
            dockerfile: docker/serve.Dockerfile
            port: 8000
            health_path: /health
          - name: onnx
            dockerfile: docker/serve-onnx.Dockerfile
            port: 8080
            health_path: /health
    steps:
      - uses: actions/checkout@v4

      - name: Build image locally for smoke test
        run: |
          docker build -f ${{ matrix.variant.dockerfile }} \
            -t etpgt-smoke-${{ matrix.variant.name }}:test .

      - name: Start container
        run: |
          docker run -d --name smoke-test \
            -p ${{ matrix.variant.port }}:${{ matrix.variant.port }} \
            -e DEMO_MODE=true \
            etpgt-smoke-${{ matrix.variant.name }}:test

      - name: Wait for health check
        run: |
          echo "Waiting for container to be healthy..."
          for i in $(seq 1 30); do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
              http://localhost:${{ matrix.variant.port }}${{ matrix.variant.health_path }} 2>/dev/null || echo "000")
            if [ "${STATUS}" = "200" ]; then
              echo "Health check passed on attempt ${i}"
              exit 0
            fi
            echo "Attempt ${i}: HTTP ${STATUS}"
            sleep 2
          done
          echo "Health check failed after 30 attempts"
          docker logs smoke-test
          exit 1

      - name: Cleanup
        if: always()
        run: docker rm -f smoke-test 2>/dev/null || true

  summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [build-scan-push, smoke-test]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## CD Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Step | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Build & Scan | ${{ needs.build-scan-push.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Smoke Tests | ${{ needs.smoke-test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
