name: Deploy Model

on:
  workflow_dispatch:
    inputs:
      model_version:
        description: 'Model version tag (default: git SHA)'
        required: false
        default: ''
        type: string
      variant:
        description: 'Model variant to deploy'
        required: true
        default: 'onnx'
        type: choice
        options:
          - onnx
          - pytorch
          - both
      traffic_percentage:
        description: 'Traffic percentage for canary (0-100)'
        required: false
        default: '10'
        type: string
      environment:
        description: 'Target environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

  workflow_call:
    inputs:
      model_version:
        type: string
        default: ''
      variant:
        type: string
        default: 'onnx'
      traffic_percentage:
        type: string
        default: '10'
      environment:
        type: string
        default: 'staging'

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_REGION: ${{ secrets.GCP_REGION }}
  AR_REPO: ${{ secrets.AR_REPO }}
  GCS_BUCKET: ${{ secrets.GCS_BUCKET }}

jobs:
  quality-gate:
    name: Model Quality Gate
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'
          cache-dependency-path: |
            requirements.txt
            pyproject.toml

      - name: Install dependencies
        run: |
          pip install torch --index-url https://download.pytorch.org/whl/cpu
          pip install torch-geometric
          pip install -e .
          pip install pyyaml

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Download model checkpoint
        run: |
          VERSION="${{ inputs.model_version || github.sha }}"
          mkdir -p artifacts
          gsutil -m cp \
            "gs://${{ env.GCS_BUCKET }}/models/serving/latest/best_model.pt" \
            artifacts/best_model.pt

      - name: Run quality gate
        run: |
          python scripts/pipeline/model_quality_gate.py \
            --checkpoint artifacts/best_model.pt \
            --artifact-only \
            --output artifacts/quality_gate_results.json

      - name: Upload quality gate results
        uses: actions/upload-artifact@v4
        with:
          name: quality-gate-results
          path: artifacts/quality_gate_results.json

  build-and-push:
    name: Build & Push (${{ inputs.variant }})
    runs-on: ubuntu-latest
    needs: [quality-gate]
    permissions:
      contents: read
      id-token: write
    outputs:
      image_uri: ${{ steps.push.outputs.image_uri }}

    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev

      - name: Determine Dockerfile
        id: config
        run: |
          VARIANT="${{ inputs.variant }}"
          if [ "${VARIANT}" = "pytorch" ] || [ "${VARIANT}" = "both" ]; then
            echo "dockerfile=docker/serve.Dockerfile" >> $GITHUB_OUTPUT
            echo "image_suffix=etpgt-serve" >> $GITHUB_OUTPUT
          else
            echo "dockerfile=docker/serve-onnx.Dockerfile" >> $GITHUB_OUTPUT
            echo "image_suffix=etpgt-serve-onnx" >> $GITHUB_OUTPUT
          fi

      - name: Build image
        run: |
          VERSION="${{ inputs.model_version || github.sha }}"
          IMAGE="${{ env.AR_REPO }}/${{ steps.config.outputs.image_suffix }}"
          docker build -f ${{ steps.config.outputs.dockerfile }} \
            -t ${IMAGE}:${VERSION} \
            -t ${IMAGE}:latest \
            .

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ env.AR_REPO }}/${{ steps.config.outputs.image_suffix }}:${{ inputs.model_version || github.sha }}'
          format: 'table'
          exit-code: '1'
          severity: 'CRITICAL,HIGH'
          ignore-unfixed: true

      - name: Push image
        id: push
        run: |
          VERSION="${{ inputs.model_version || github.sha }}"
          IMAGE="${{ env.AR_REPO }}/${{ steps.config.outputs.image_suffix }}"
          docker push ${IMAGE}:${VERSION}
          docker push ${IMAGE}:latest
          echo "image_uri=${IMAGE}:${VERSION}" >> $GITHUB_OUTPUT

  register-model:
    name: Register Model in Vertex AI
    runs-on: ubuntu-latest
    needs: [build-and-push]
    permissions:
      contents: read
      id-token: write
    outputs:
      model_id: ${{ steps.register.outputs.model_id }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install google-cloud-aiplatform

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Register model
        id: register
        run: |
          VERSION="${{ inputs.model_version || github.sha }}"
          VARIANT="${{ inputs.variant == 'pytorch' && 'pytorch' || 'onnx' }}"
          python scripts/gcp/05_register_vertex_model.py \
            --project-id ${{ env.GCP_PROJECT_ID }} \
            --region ${{ env.GCP_REGION }} \
            --model-name "gat-rec-${VARIANT}-${VERSION}" \
            --container-image "${{ needs.build-and-push.outputs.image_uri }}" \
            --artifact-uri "gs://${{ env.GCS_BUCKET }}/models/serving/latest" \
            --variant ${VARIANT}

  deploy-canary:
    name: Canary Deployment
    runs-on: ubuntu-latest
    needs: [register-model]
    permissions:
      contents: read
      id-token: write

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install google-cloud-aiplatform

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Deploy with canary traffic
        run: |
          TRAFFIC="${{ inputs.traffic_percentage }}"
          echo "Deploying with ${TRAFFIC}% traffic"
          python scripts/gcp/06_deploy_endpoint.py \
            --project-id ${{ env.GCP_PROJECT_ID }} \
            --region ${{ env.GCP_REGION }} \
            --model-id "${{ needs.register-model.outputs.model_id }}" \
            --traffic-split ${TRAFFIC}

  smoke-test-endpoint:
    name: Endpoint Smoke Test
    runs-on: ubuntu-latest
    needs: [deploy-canary]
    permissions:
      contents: read
      id-token: write

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install google-cloud-aiplatform numpy

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Benchmark endpoint
        id: benchmark
        run: |
          python scripts/gcp/07_benchmark_endpoint.py \
            --project-id ${{ env.GCP_PROJECT_ID }} \
            --region ${{ env.GCP_REGION }} \
            --endpoint-name gat-recommendation-endpoint \
            --num-requests 20 \
            --output benchmark_results.json

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: benchmark_results.json

  summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [quality-gate, build-and-push, register-model, deploy-canary, smoke-test-endpoint]
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "## Deployment Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Step | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Quality Gate | ${{ needs.quality-gate.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build & Push | ${{ needs.build-and-push.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Register Model | ${{ needs.register-model.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Canary Deploy | ${{ needs.deploy-canary.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Smoke Test | ${{ needs.smoke-test-endpoint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Variant**: ${{ inputs.variant }}" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Traffic**: ${{ inputs.traffic_percentage }}%" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: ${{ inputs.model_version || github.sha }}" >> $GITHUB_STEP_SUMMARY
